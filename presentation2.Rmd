---
title: "Colombia COVID-19 - Central region"
author: "Angela Carraro, Giullia Monteiro Milano Oliveira, Gaia Saveri"
date: "3/07/2020"
output:
  ioslides_presentation:
    # “default”, “cerulean”, “journal”, “flatly”, “darkly”, “readable”, “spacelab”, “united”, “cosmo”, “lumen”, “paper”, “sandstone”, “simplex”, “yeti”
    highlight: kate
    theme: "sandstone"
    colortheme: "sandstone"
    lightbox: true
    widescreen: true
    smaller: true
    logo: Logo_units_blu.png #logo_dssc_alt.png
  rmdformats::readthedown:
  slidy_presentation:
    fig.height: 3
    fig.width: 4
    highlight: kate
  beamer_presentation:
    highlight: tango
    theme: "metropolis"
    colortheme: "metropolis"
    fonttheme: "structurebold"
    always_allow_html: true
  html_document:
    highlight: kate
    lightbox: true
    gallery: true
    toc: yes
    toc_depth: 3
  include: null
  pdf_document:
    highlight: kate
    keep_tex: yes
    toc: yes
  slide_level: 2
header-includes:
- \usepackage{color}
- \definecolor{Purple}{HTML}{911146}
- \definecolor{Orange}{HTML}{CF4A30}
- \setbeamercolor{alerted text}{fg=Orange}
- \setbeamercolor{frametitle}{bg=Purple}
institute: University of Trieste
graphics: yes
fontsize: 8pt
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center', warning=FALSE, message=FALSE, fig.asp=0.625, dev='png', global.par = TRUE, dev.args=list(pointsize=10), fig.path = 'figs/')
```

```{r setup, include=FALSE}
library(knitr)
local({
  hook_plot = knit_hooks$get('plot')
  knit_hooks$set(plot = function(x, options) {
    paste0('\n\n----\n\n', hook_plot(x, options))
  })
})
knitr::opts_chunk$set(echo = FALSE, tidy = TRUE)
```

```{r message=FALSE, include=FALSE}
library(MASS)
library(readr)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(leaflet)
library(geojsonio)
library(htmltools)
library(htmlwidgets)

library(rstan)
library(bayesplot)
library(lubridate)
```

## Our project

We decided to do **central Colombia**, basically because it is where the capital is.

We built a model for the number of `confirmed` cases using all the others covariates (plus some we created) and we estimated the predictive accuracy of our selected model.

## Loading the dataset

```{r loading}
colombia_covid <- as.data.frame(read_csv("data/datasets_567855_1056808_Casos1.csv"))
colnames(colombia_covid)[5] <- "Atención"
colnames(colombia_covid)[8] <- "Tipo"
# slicing the main dataset
central.colombia.dep <- c("Bogotá D.C.", "Tolima", "Cundinamarca", "Meta", "Boyacá", "Quindío", "Cauca",
    "Valle del Cauca", "Risaralda", "Caldas", "Boyacá", "Antioquia", "Santander", "Casanare")
central.colombia.rows <- which(colombia_covid$`Departamento o Distrito` %in% central.colombia.dep)
colombia_covid <- colombia_covid[central.colombia.rows, ]
```

## Our cities

We decided to consider as **central Colombia** the following cities:

 - Bogotà DC,
 - Boyacá,
 - Tolima,
 - Cundinamarca,
 - Meta,
 - Quindío,
 - Valle del Cauca,
 - Risaralda, Celdas,
 - Boyacá,
 - Antioquia,
 - Santander
 - Casanare
 
## Map

Here we can see our selected cities. The color of the pins is related with the number of cases: if they are less than $10$ the color is "green", if they are less than $100$ the color is "orange", otherwise it is "red".

```{r create_gis_df, include=FALSE}
#lat-long
#bogota<c(4.592164298, -74.072166378, 542)
valle_de_cauca<-c("Valle del Cauca", 3.4372200, -76.5225000, 150)
cauca<-c("Cauca", 2.43823, -76.6131592, 12) 
antioquia<-c("Antioquia",6.2518400, -75.5635900, 127)
cartagena<-c("Cartagena D.T. y C", 10.39972, -75.51444, 39)
huila<-c("Huila", 2.9273, -75.2818909, 30)
meta<-c("Meta", 4.1420000, -73.6266400, 12)
risaralda<-c("Risaralda", 4.8133302, -75.6961136, 35)
norte_santander<-c("Norte de Santander", 7.8939100, -72.5078200, 21)
caldas<-c("Caldas", 5.0688900, -75.5173800, 16)
cudinamarca<-c("Cundinamarca", 4.862437, -74.058655, 42)
barraquilla<-c("Barranquilla D.E.", 10.9685400, -74.7813200, 35) #atlantico
santader<-c("Santander", 7.1253900, -73.1198000, 12)
quindio<-c("Quindío", 4.535000, -75.675690, 23)
tolima<-c("Tolima", 4.43889, -75.2322235, 14)
santa_marta<-c("Santa Marta D.T. y C.", 11.24079, -74.19904, 12)
cesar<-c("Cesar", 10.4631400, -73.2532200, 16)
san_andres<-c("San Andrés", 12.5847197, -81.7005615, 2)
casanare<-c("Casanare", 5.3377500, -72.3958600, 2)
narino<-c("Nariño", 1.2136100, -77.2811100, 6)
boyaca<-c("Boyacá", 5.767222, -72.940651, 6)
cordoba<-c("Córdoba", 8.7479800, -75.8814300, 2)
bolivar<-c("Bolívar", 10.3997200, -75.5144400, 3)
sucre<-c("Sucre", 9.3047199, -75.3977814, 1)
guajira<-c("La Guajira", 11.5444400, -72.9072200, 1)

gis_data<-data.frame(name="Bogotá D.C.", latitude=4.624335, longitude=-74.063644, cases=542) #bogotà
gis_data$name<-as.character(gis_data$name)
gis_data<-rbind(gis_data, cauca)
gis_data<-rbind(gis_data, valle_de_cauca)
gis_data<-rbind(gis_data, antioquia)
gis_data<-rbind(gis_data, cartagena)
gis_data<-rbind(gis_data, huila)
gis_data<-rbind(gis_data, meta)
gis_data<-rbind(gis_data, risaralda)
gis_data<-rbind(gis_data, norte_santander)
gis_data<-rbind(gis_data, caldas)
gis_data<-rbind(gis_data, cudinamarca)
gis_data<-rbind(gis_data, barraquilla)
gis_data<-rbind(gis_data, santader)
gis_data<-rbind(gis_data, quindio)
gis_data<-rbind(gis_data, tolima)
gis_data<-rbind(gis_data, santa_marta)
gis_data<-rbind(gis_data, cesar)
gis_data<-rbind(gis_data, san_andres)
gis_data<-rbind(gis_data, casanare)
gis_data<-rbind(gis_data, narino)
gis_data<-rbind(gis_data, boyaca)
gis_data<-rbind(gis_data, cordoba)
gis_data<-rbind(gis_data, bolivar)
gis_data<-rbind(gis_data, sucre)
gis_data<-rbind(gis_data, guajira)

gis_data$latitude<-as.numeric(gis_data$latitude)
gis_data$longitude<-as.numeric(gis_data$longitude)
gis_data$cases<-as.numeric(gis_data$cases)
```

```{r central_colombia, echo=FALSE, inlcude=FALSE}
dept<-geojsonio::geojson_read("data/Colombia.geo.json", what="sp")
#slice the gis_data dataset
central_gis_data<-gis_data[which(gis_data$name %in% central.colombia.dep),]
#slice the geojson dataset 
central_dept<-c("SANTAFE DE BOGOTA D.C", "TOLIMA", "CUNDINAMARCA", "META", "BOYACA", "QUINDIO", "CAUCA", "VALLE DEL CAUCA", "RISARALDA", "CALDAS", "BOYACA", "ANTIOQUIA", "SANTANDER", "CASANARE")
central.dept<-dept[which(dept@data$NOMBRE_DPT %in% central_dept),]
```

```{r our_map, echo=TRUE, warning=FALSE, include=FALSE}
getColor <- function(central_gis_data) {
  sapply(central_gis_data$cases, function(cases) {
  if(cases <= 10) {
    "green"
  } else if(cases <= 100) {
    "orange"
  } else {
    "red"
  } })
}

icons <- awesomeIcons(
  icon = 'ios-close',
  iconColor = 'black',
  library = 'ion',
  markerColor = getColor(central_gis_data)
)

#now colombia is yellow and our departments are red

central_map <- leaflet(data=central_gis_data) %>% addTiles() %>%
  addAwesomeMarkers(~longitude, ~latitude, icon=icons, label = ~htmlEscape(paste(name,cases,sep=" : "))) %>%
  addProviderTiles(providers$CartoDB.Positron) %>%
  addPolygons(data=dept,
              opacity=0.1,
              color="yellow",
              fillOpacity = 0.1) %>%
  addPolygons(data=central.dept,     
              opacity = 0.2,
              color = "red",
              dashArray = "3",
              fillOpacity = 0.1)
#saveWidget(central_map, file="figs/central_colombia.html")
```

```{r}
central_map
```


## Preprocessing {.smaller}

```{r types, include=FALSE, echo=FALSE}
# there were missing rows
colombia_covid$`ID de caso` <- 1:dim(colombia_covid)[1]
## day column in "international" format (so that R can fix the sorting properly)
colombia_covid$`Fecha de diagnóstico` <- as.Date(colombia_covid$`Fecha de diagnóstico`, format="%d/%m/%Y")
colombia_covid <- colombia_covid %>% mutate("Grupo de edad" = case_when(Edad <= 18 ~ '0-18',
                                                   Edad >= 19  & Edad <= 30 ~ '19-30',
                                                   Edad >=  31 & Edad <= 45 ~ '31-45',
                                                   Edad >= 46 & Edad <= 60 ~ '46-60',
                                                   Edad >=61 & Edad <= 75 ~ '60-75',
                                                   Edad >=76 ~ '76+'))
colombia_covid$`Grupo de edad` <- as.factor(colombia_covid$`Grupo de edad`)
colombia_covid$`Departamento o Distrito` <- as.factor(colombia_covid$`Departamento o Distrito`)
colombia_covid$`Ciudad de ubicación` <- as.factor(colombia_covid$`Ciudad de ubicación`)
colombia_covid$Sexo <- as.factor(colombia_covid$Sexo)
colombia_covid$Atención <- as.factor(colombia_covid$Atención)
colombia_covid$Tipo <- as.factor(colombia_covid$Tipo)
```

```{r fix_countries, include=FALSE}
sort(unique(colombia_covid$`País de procedencia`))
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Isla Martin - Caribe"] <- "Islas San Martin"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Israel Egipto"] <- "Israel - Egipto"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Jamaica - Isla Caimán - Panamá"] <- "Jamaica - Panamá - Isla Caimán"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Madrid"] <- "España"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Londres"] <- "Inglaterra"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Alemania - Estambul"] <- "Alemania - Turquía"
colombia_covid$`País de procedencia`[colombia_covid$`País de procedencia` == "Jamaica - Panamá - Islas del caribe - Cartagena"] <- "Jamaica - Panamá - Colombia"
colombia_covid$`País de procedencia` <- as.factor(colombia_covid$`País de procedencia`)
```

```{r create_continents, include=FALSE}
Europa <- c("Alemania", "Bélgica", "Europa",  "Croacia", "España", "España - Croacia", "España - Croacia - Bosnia",  "España - Francia", "España - Italia", "Francia", "Francia - Holanda", "Grecia", "Inglaterra", "Italia", "Italia - Ucrania - España", "Suiza")
Asia <- c("Arabia", "Emiratos Árabes", "Turquía")
África <- c("Egipto", "Marruecos")
Norteamérica <- c("Canadá", "Estados Unidos", "México")
Centroamérica <- c("Aruba", "Costa Rica", "Cuba", "Guatemala", "Islas San Martin", "Jamaica", "Jamaica - Panamá - Isla Caimán", "Jamaica - Panamá - Islas del caribe - Cartagena", "Panamá", "Panamá - Jamaica", "Puerto Rico", "República Dominicana")
Sudamerica <- c("Argentina", "Brasil", "Chile", "Ecuador", "Perú", "Venezuela")
# Alemania - Turquía", "España - India", "España - Turquia", "Italia - España - Turquía", "Turquía - Grecia" -> "Europa - Asia"
# "España - Egipto" -> "Europa - África"
# "Israel - Egipto" -> "Asia - África"
# "Italia - Jamaica - Panamá" -> "Europa - Centroamérica"
# "Colombia" -> "Colombia"

for (i in 1:nrow(colombia_covid)) {
  if (colombia_covid$`País de procedencia`[i] %in% Europa){
    colombia_covid$`Continente de procedencia`[i] <- "Europa"}
  else if (colombia_covid$`País de procedencia`[i] %in% Asia){
    colombia_covid$`Continente de procedencia`[i] <- "Asia"}
  else if (colombia_covid$`País de procedencia`[i] %in% África){
    colombia_covid$`Continente de procedencia`[i] <- "África"}
  else if (colombia_covid$`País de procedencia`[i] %in% Norteamérica){
    colombia_covid$`Continente de procedencia`[i] <- "Norteamérica"}
  else if (colombia_covid$`País de procedencia`[i] %in% Centroamérica){
    colombia_covid$`Continente de procedencia`[i] <- "Centroamérica"}
  else if (colombia_covid$`País de procedencia`[i] %in% Sudamerica){
    colombia_covid$`Continente de procedencia`[i] <- "Sudamerica"}
  else if (colombia_covid$`País de procedencia`[i] == "Colombia"){
    colombia_covid$`Continente de procedencia`[i] <- "Colombia"}
  else if (colombia_covid$`País de procedencia`[i] == "Alemania - Turquía"){
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Asia"}
  else if (colombia_covid$`País de procedencia`[i] == "España - India")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Asia"
  else if (colombia_covid$`País de procedencia`[i] == "España - Turquia")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Asia"
  else if (colombia_covid$`País de procedencia`[i] == "Italia - España - Turquía")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Asia"
  else if (colombia_covid$`País de procedencia`[i] == "Turquía - Grecia")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Asia"
  else if (colombia_covid$`País de procedencia`[i] == "España - Egipto")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - África"
  else if (colombia_covid$`País de procedencia`[i] == "Israel - Egipto")
    colombia_covid$`Continente de procedencia`[i] <- "Asia - África"
  else if (colombia_covid$`País de procedencia`[i] == "Italia - Jamaica - Panamá")
    colombia_covid$`Continente de procedencia`[i] <- "Europa - Centroamérica"
}
colombia_covid$`Continente de procedencia` <- as.factor(colombia_covid$`Continente de procedencia`)
# Transforming the 0 value into a null value
colombia_covid[911,]$`País de procedencia` <- NA
```

```{r display}
head(colombia_covid)
```

```{r relevant_dp}
covid_dp <- colombia_covid %>%
  group_by(`Fecha de diagnóstico`,`Departamento o Distrito`) %>%
  count()
#the max of the ID de caso for each date is the cumulative number of cases confirmed up to that date
cumulative <- colombia_covid %>%
  group_by(`Fecha de diagnóstico`, `Departamento o Distrito`) %>%
  summarise(max(`ID de caso`))
names(cumulative)[3] <- "Cumulative cases"
covid_dp <- bind_cols(covid_dp, cumulative %>% ungroup() %>%
  dplyr::select(-c(`Fecha de diagnóstico`, `Departamento o Distrito`)))
covid_dp <- as.data.frame(covid_dp)
covid_dp <- covid_dp %>% mutate(BETWEEN0 = as.numeric(difftime(Date, lag(Date, 1), units = "days")),
            BETWEEN = ifelse(is.na(BETWEEN0), 0, BETWEEN0), `Elapsed time` =
              cumsum(as.numeric(BETWEEN))) %>% dplyr::select(-c(BETWEEN0,BETWEEN))
```


```{r cumul_dept, include=FALSE}
#departments with more than 30 cases
relevant <- c("Bogotá D.C.", "Valle del Cauca", "Antioquia", "Cundinamarca", "Risaralda")
covid_relevant_dp <- as.data.frame(subset(covid_dp, Department %in% relevant))
#boring and absolutely not efficient population of the number of cumulative cases
cumulative_dep <- rep(0, 83)
covid_relevant_dp <- cbind(covid_relevant_dp, cumulative_dep)
for (i in as.numeric(rownames(covid_relevant_dp[which(covid_relevant_dp$Department=="Bogotá D.C."),]))) {
  if(i==1){
    covid_relevant_dp[i,4]<-covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
  else {
    covid_relevant_dp[i,4]<-prev+covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
}
for (i in as.numeric(rownames(covid_relevant_dp[which(covid_relevant_dp$Department=="Valle del Cauca"),]))) {
  if(i==3){
    covid_relevant_dp[i,4]<-covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
  else {
    covid_relevant_dp[i,4]<-prev+covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
}
for (i in as.numeric(rownames(covid_relevant_dp[which(covid_relevant_dp$Department=="Antioquia"),]))) {
  if(i==2){
    covid_relevant_dp[i,4]<-covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
  else {
    covid_relevant_dp[i,4]<-prev+covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
}
for (i in as.numeric(rownames(covid_relevant_dp[which(covid_relevant_dp$Department=="Cundinamarca"),]))) {
  if(i==13){
    covid_relevant_dp[i,4]<-covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
  else {
    covid_relevant_dp[i,4]<-prev+covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
}
for (i in as.numeric(rownames(covid_relevant_dp[which(covid_relevant_dp$Department=="Risaralda"),]))) {
  if(i==14){
    covid_relevant_dp[i,4]<-covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
  else {
    covid_relevant_dp[i,4]<-prev+covid_relevant_dp[i,3]
    prev<-covid_relevant_dp[i,4]
  }
}
```

```{r dataset_cumulative}
covid_relevant_dp <- covid_relevant_dp[order(covid_relevant_dp$Department), ]
covid_relevant_dp <- covid_relevant_dp[, c(1,5,2,3,4)]
names(covid_relevant_dp) <- c("Date", "Elapsed time", "Department", "New cases/day", "Cumulative cases/Department")
head(covid_relevant_dp)
```


## Exploring the dataset

Number of cases confirmed day by day

```{r barplot, echo=FALSE, warning=FALSE}
theme_set(theme_classic())

colorCount<-length(unique(colombia_covid$`Departamento o Distrito`)) 
getPalette<-colorRampPalette(brewer.pal(9, "Spectral"))(colorCount)

daily_confirmed<-ggplot(colombia_covid, aes(x = `Fecha de diagnóstico`)) +
  scale_fill_manual(values = getPalette)
daily_confirmed + geom_histogram(aes(fill=`Departamento o Distrito`), width = 0.8, stat="count") + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6),
        legend.position = "right") +
  labs(title = "Daily number of confirmed cases", 
       subtitle = "subdivided across departments",
       x = "Date of confirmation",
       fill = "Department")
```


# The frequentist approach

### Running poisson with `Elapsed time` as predictor 

```{r Giullia2, warning=FALSE}
#Running poisson with just the variable representing the time as predictor 
poisson1 <- glm(`Cumulative cases/Department` ~ `Elapsed time`, data=covid_relevant_dp, family=poisson)
summary(poisson1)
```

# The Bayesian approach

## Poisson regression

As a first attempt, we fit a simple Poisson regression:

$$
ln\lambda_i = \alpha + \beta\cdot elapsed\_time_i \\
y_i \sim \mathcal{Poisson}(\lambda_i)
$$
with $i = 1,\dots,83$, and $y_i$ represents the number of cases.

```{r stan_poisson_regression, warning=FALSE}
model.Poisson <- stan_model("stan/poisson_regression.stan")
#arrange things
model.data <- list(
  N = nrow(covid_relevant_dp),
  cases = covid_relevant_dp$`New cases/day`,
  time = covid_relevant_dp$`Elapsed time`
)
#str(model.Poisson.data)

#run the model 
fit.model.Poisson<-sampling(model.Poisson, data=model.data)

#inferred parameters
print(fit.model.Poisson, pars=c("alpha", "beta"))
```

Looking at `Rhat` we can see that we have reached the convergence.

```{r first_plot, echo=TRUE, warning=FALSE}
theme_set(bayesplot::theme_default())

mcmc_scatter(as.matrix(fit.model.Poisson, pars=c("alpha", "beta") ), alpha=0.2)
```

Check the posterior:

```{r poisson_posterior, echo=TRUE, warning=FALSE}
y_rep <- as.matrix(fit.model.Poisson, pars="y_rep")
ppc_dens_overlay(y = model.data$cases, y_rep[1:200,]) 
```

The model is not able to capture low and high numbers of new cases.

The fit is not satisfactory, it is probably due to overdispersion, we can check the residuals to confirm this hypothesis: 

```{r first_residual, echo=TRUE, warning=FALSE}
#in this way we check the standardized residuals
mean_y_rep<-colMeans(y_rep)
std_residual<-(model.data$cases - mean_y_rep) / sqrt(mean_y_rep)
qplot(mean_y_rep, std_residual) + hline_at(2) + hline_at(-2)
```

The variance of the residuals increases as the predicted value increase. The standardized residuals should have mean 0 and standard deviation 1 (hence the lines at +2 and -2 indicates approximate 95% error bounds). The variance of the standardized residuals is much greater than 1, indicating a large amount of overdispersion. 

Classically the problem of having overdispersed data is solved using the negative binomial model instead of the Poisson one.

## Angela stan

```{r stan_pois_2}
model.Poisson<-stan_model("stan/poisson_regression.stan")
#arrange things
model.data<-list(
  N = nrow(data1),
  cases = data1$y,
  time = data1$elapsed_time
)
#str(model.Poisson.data)

#run the model 
fit.model.Poisson<-sampling(model.Poisson, data=model.data)

#inferred parameters
print(fit.model.Poisson, pars=c("alpha", "beta"))

y_rep<-as.matrix(fit.model.Poisson, pars="y_rep")
ppc_dens_overlay(y = model.data$cases, y_rep[1:200,]) 
```


## Negative binomial model

